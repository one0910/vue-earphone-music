import{_ as k,P as z,X as I,Y as T,h as x,s as v,A as M,R as N,F as g,o as u,d as b,G as l,e,n as h,w as m,H as y,I as w,J as D,t as f,f as S,g as R,Z as C,$ as F,K as $}from"./index-MWUSZCKJ.js";const E={name:"Upload",data(){return{is_dragover:!1,uploadsTemp:[],uploadSchema:{albumName:"required",albumSinger:"required",albumCoverImgUrl:"required",albumGenre:"required"},userData:{albumGenre:"America"},toggle:!1,message:""}},props:["addSong"],components:{toastMessage:z},methods:{upload(t){const s=t.dataTransfer?[...t.dataTransfer.files]:[...t.target.files];console.log("files => ",s),s.forEach(o=>{if(o.type!=="audio/mpeg"){this.toggle=!this.toggle,this.message=`${o.name}非mp3檔，請重傳`;return}this.uploadsTemp.push({file:o,current_progress:0,icon:"",text_class:"",variant:"",isUploadComplete:!1,isUploading:!1})})},deleteSong(t){this.uploadsTemp.splice(t,1)},uploadSubmit(t){this.uploadsTemp.forEach((s,o)=>{const a=I.ref().child(`songs/${s.file.name}`).put(s.file);this.uploadsTemp[o].icon="fas fa-spinner fa-spin",this.uploadsTemp[o].variant="bg-blue-400",this.uploadsTemp[o].isUploading=!0,a.on("state_changed",i=>{let d=i.bytesTransferred/i.totalBytes*100;this.uploadsTemp[o].current_progress=d},i=>{this.uploadsTemp[o].variant="bg-red-400",this.uploadsTemp[o].icon="fa fa-times",this.uploadsTemp[o].text_class="text-red-400"},async()=>{try{const i={album:t.albumName,coverImg:t.albumCoverImgUrl,uid:T.currentUser.uid,display_name:t.albumSinger,original_name:a.snapshot.ref.name,modified_name:x.formatSongName(a.snapshot.ref.name),genre:t.albumGenre,comment_count:0},d={albumDesc:"",albumImg:t.albumCoverImgUrl,albumName:t.albumName,albumSinger:t.albumSinger,albumSingerDesc:"",albumSingerImg:""};i.url=await a.snapshot.ref.getDownloadURL();const c=await(await v.add(i)).get();this.addSong(c),await M.doc(t.albumGenre.toLowerCase()).update({items:N.firestore.FieldValue.arrayUnion(d)}),console.log("Album added successfully"),this.uploadsTemp[o].variant="bg-green-400",this.uploadsTemp[o].icon="fa fa-check",this.uploadsTemp[o].text_class="text-green-400",this.uploadsTemp[o].isUploadComplete=!0}catch(i){console.log("error => ",i)}})})},formatIndex:x.formatIndex,formatSongName:x.formatSongName}},A={class:"bg-zinc-900 rounded border border-gray-200 relative flex flex-col"},q=e("div",{class:"px-6 pt-5 pb-3 font-bold border-b border-gray-200"},[e("span",{class:"card-title"},"上傳歌曲"),e("i",{class:"fas fa-upload float-right text-rose-500 text-xl"})],-1),G={class:"p-6"},B=e("h5",null,"請拖曳檔案到此",-1),V=[B],L=e("hr",{class:"my-6"},null,-1),J=e("label",{class:"inline-block mb-2"},"歌手名稱",-1),K=e("label",{class:"inline-block mb-2"},"專輯名稱",-1),j=e("label",{class:"inline-block mb-2"},"專輯類型",-1),P=e("option",{class:"bg-gray-700 text-zinc-100",value:"America"},"America",-1),H=e("option",{class:"bg-gray-700 text-zinc-100",value:"Kpop"},"Kpop",-1),O=e("option",{class:"bg-gray-700 text-zinc-100",value:"Jpop"},"Jpop",-1),X=e("option",{class:"bg-gray-700 text-zinc-100",value:"Music"},"Music",-1),Y=e("label",{class:"inline-block mb-2"},"專輯封面",-1),Z=e("p",{class:"mb-3 border-b-2 border-[#fff]/30 pb-2"},"要上傳的歌曲:",-1),Q={class:"flex items-center justify-between"},W={class:"overflow-hidden flex items-center"},ee={class:"pl-2 truncate"},se={class:""},te=["onClick"],oe=e("i",{class:"fa fa-times"},null,-1),ne=[oe],ae={key:0,class:"flex h-4 mt-1 overflow-hidden bg-gray-200 rounded"},re=["disabled"];function le(t,s,o,_,n,a){const i=g("toastMessage"),d=g("vee-field"),p=g("ErrorMessage"),c=g("vee-form");return u(),b(w,null,[l(i,{toggle:n.toggle,message:n.message},null,8,["toggle","message"]),e("div",A,[q,e("div",G,[e("div",{class:h(["w-full px-10 py-20 rounded text-center cursor-pointer border border-dashed border-gray-400 text-gray-400 transition duration-00 hover:text-white hover:bg-rose-500/40 hover:border-rose-500 hover:border-solid",{"bg-rose-500 border-rose-500 border-solid":n.is_dragover}]),onDrag:s[0]||(s[0]=m(()=>{},["prevent","stop"])),onDragstart:s[1]||(s[1]=m(()=>{},["prevent","stop"])),onDragend:s[2]||(s[2]=m(r=>n.is_dragover=!1,["prevent","stop"])),onDragover:s[3]||(s[3]=m(r=>n.is_dragover=!0,["prevent","stop"])),onDragenter:s[4]||(s[4]=m(r=>n.is_dragover=!0,["prevent","stop"])),onDragleave:s[5]||(s[5]=m(r=>n.is_dragover=!1,["prevent","stop"])),onDrop:s[6]||(s[6]=m(r=>a.upload(r),["prevent","stop"]))},V,34),e("input",{class:"block w-full text-md borderrounded-lg cursor-pointer text-gray-400 focus:outline-none mt-4",type:"file",multiple:"",onChange:s[7]||(s[7]=r=>a.upload(r))},null,32),L,l(c,{"validation-schema":n.uploadSchema,onSubmit:a.uploadSubmit,"initial-values":n.userData},{default:y(()=>[e("div",null,[J,l(d,{type:"text",name:"albumSinger",class:"block w-full py-1.5 px-3 mb-4 bg-white/10 text-zinc-100 border border-gray-300 transition duration-500 focus:outline-none focus:border-black rounded",placeholder:"歌手名稱"}),l(p,{class:"text-pink-600",name:"albumSinger"})]),e("div",null,[K,l(d,{type:"text",name:"albumName",class:"block w-full py-1.5 px-3 mb-4 bg-white/10 text-zinc-100 border border-gray-300 transition duration-500 focus:outline-none focus:border-black rounded",placeholder:"專輯名稱"}),l(p,{class:"text-pink-600",name:"albumName"})]),e("div",null,[j,l(d,{as:"select",name:"albumGenre",class:"block w-full py-1.5 px-3 mb-4 bg-white/10 text-zinc-100 border border-gray-300 transition duration-500 focus:outline-none focus:border-black rounded"},{default:y(()=>[P,H,O,X]),_:1}),l(p,{class:"text-red-600",name:"albumGenre"})]),e("div",null,[Y,l(d,{type:"text",name:"albumCoverImgUrl",class:"block w-full py-1.5 px-3 mb-4 bg-white/10 text-zinc-100 border border-gray-300 transition duration-500 focus:outline-none focus:border-black rounded",placeholder:"專輯封面"}),l(p,{class:"text-pink-600",name:"albumCoverImgUrl"})]),Z,(u(!0),b(w,null,D(n.uploadsTemp,(r,U)=>(u(),b("div",{class:"mb-4",key:r.file.name},[e("div",{class:h(["border border-zinc-200 p-2 mb-4 rounded font-bold text-sm",r.text_class])},[e("div",Q,[e("div",W,[e("i",{class:h(r.icon)},null,2),e("p",ee,f(a.formatIndex(U))+". "+f(a.formatSongName(r.file.name)),1)]),e("div",se,[r.isUploadComplete?S("",!0):(u(),b("button",{key:0,class:"ml-1 py-1 px-2 text-sm rounded text-white bg-rose-600",onClick:m(Re=>a.deleteSong(U),["prevent"])},ne,8,te))])])],2),r.isUploading?(u(),b("div",ae,[e("div",{class:h(["transition-all progress-bar",r.variant]),style:R({width:r.current_progress+"%"})},null,6)])):S("",!0)]))),128)),e("button",{type:"submit",class:"py-1 px-3 mr-2 rounded text-zinc-100 bg-rose-500 w-full hover:bg-rose-600 disabled:bg-zinc-700 disabled:text-zinc-400",disabled:n.uploadsTemp.length==0}," 檔案上傳 ",8,re)]),_:1},8,["validation-schema","onSubmit","initial-values"])])])],64)}const ie=k(E,[["render",le]]),de={name:"CompositionItem",data(){return{showForm:!1,schema:{modified_name:"required",genre:"alpha_spaces"},is_submission:!1,show_alart:!1,alert_variant:"bg-blue-500",alert_message:"Please wait! Updating song info"}},props:{song:{type:Object,required:!0},updateSong:{type:Function,required:!0},index:{type:Number},removeSong:{type:Function,required:!0},updateUnsaveFlag:{type:Function}},methods:{async edit(t){this.is_submission=!0,this.show_alart=!0,this.alert_variant="bg-blue-500",this.alert_message="";try{await v.doc(t.docID).update(t)}catch(s){console.log("error => ",s),this.is_submission=!1,this.alert_variant="bg-red-500",this.alert_message="Something went wrong! Try again later";return}this.updateSong(this.index,t),this.updateUnsaveFlag(!1),this.is_submission=!1,this.alert_variant="bg-green-500",this.alert_message="Success!"},async deleteSong(){const s=I.ref().child(`songs/${this.song.original_name}`);try{await s.delete(),await v.doc(this.song.docID).delete(),this.removeSong(this.index)}catch(o){console.log("error => ",o)}}},mounted(){}},ce={class:"border border-zinc-200 p-2 mb-4 rounded"},me={class:"inline-block text-sm font-bold"},ue=e("i",{class:"fa fa-times"},null,-1),ge=[ue],pe=e("i",{class:"fa fa-pencil-alt"},null,-1),be=[pe],fe={class:"mb-3"},_e={class:"inline-block mb-2"},he={class:"mb-3"},ve={class:"inline-block mb-2"},xe={type:"submit",class:"py-1 px-3 mr-2 rounded text-zinc-100 bg-green-700"},ye=["disabled"];function we(t,s,o,_,n,a){const i=g("vee-field"),d=g("ErrorMessage"),p=g("vee-form");return u(),b("div",ce,[C(e("div",null,[e("h4",me,f(o.song.modified_name),1),e("button",{class:"ml-1 py-1 px-2 text-sm rounded text-white bg-rose-600 float-right",onClick:s[0]||(s[0]=m((...c)=>a.deleteSong&&a.deleteSong(...c),["prevent"]))},ge),e("button",{class:"ml-1 py-1 px-2 text-sm rounded text-white bg-rose-400 float-right",onClick:s[1]||(s[1]=m(c=>n.showForm=!n.showForm,["prevent"]))},be)],512),[[F,!n.showForm]]),C(e("div",null,[n.show_alart?(u(),b("div",{key:0,class:h(["text-white text-center font-bold p-4 mb-4",n.alert_variant])},f(n.alert_message),3)):S("",!0),l(p,{"validation-schema":n.schema,"initial-values":o.song,onSubmit:a.edit},{default:y(()=>[e("div",fe,[e("label",_e,f(t.$t("song_name")),1),l(i,{name:"modified_name",type:"text",class:"block w-full py-1 px-3 bg-white/10 text-zinc-100 border border-gray-300 transition duration-500 focus:outline-none focus:border-black rounded",placeholder:"Enter Song Title",onInput:s[2]||(s[2]=c=>o.updateUnsaveFlag(!0))}),l(d,{class:"text-red-600",name:"modified_name"})]),e("div",he,[e("label",ve,f(t.$t("genre")),1),l(i,{name:"genre",type:"text",class:"block w-full py-1 px-3 bg-white/10 text-zinc-100 border border-gray-300 transition duration-500 focus:outline-none focus:border-black rounded",placeholder:"Enter Genre",onInput:s[3]||(s[3]=c=>o.updateUnsaveFlag(!0))}),l(d,{class:"text-red-600",name:"genre"})]),e("button",xe,f(t.$t("button.confirm")),1),e("button",{type:"button",class:"py-1 px-3 rounded text-white bg-gray-600",disabled:n.is_submission,onClick:s[4]||(s[4]=m(c=>n.showForm=!1,["prevent"]))},f(t.$t("button.cancel")),9,ye)]),_:1},8,["validation-schema","initial-values","onSubmit"])],512),[[F,n.showForm]])])}const Se=k(de,[["render",we]]),ke={name:"Manage",data(){return{songs:[],unsaveFlag:!1}},components:{toastMessage:z,UploadAdminManage:ie,CompositionItem:Se},methods:{updateSong(t,s){this.songs[t].modified_name=s.modified_name,this.songs[t].genre=s.genre},removeSong(t){this.songs.splice(t,1)},addSong(t){const s={...t.data(),docID:t.id};this.songs.push(s)},updateUnsaveFlag(t){this.unsaveFlag=t}},async created(){(await v.where("uid","==",T.currentUser.uid).get()).forEach(s=>{this.addSong(s)})},beforeRouteLeave(t,s,o){if(!this.unsaveFlag)o();else{const _=confirm("你的檔案還未修改完必，有確定要離開嗎?");o(_)}}},Ue={class:"text-zinc-200 bg-zinc-900 mt-[55px] mb-[90px] relative"},Ce={class:"container mx-auto mt-14 pt-3 pr-1 md:pr-0"},Fe={class:"md:grid md:grid-cols-3 md:gap-4"},ze={class:"col-span-1"},Ie={class:"col-span-2"},Te={class:"bg-zinc-900 rounded border border-gray-200 relative flex flex-col"},De=e("div",{class:"px-6 pt-5 pb-3 font-bold border-b border-gray-200"},[e("span",{class:"card-title"},"我的歌單"),e("i",{class:"fa fa-compact-disc float-right text-rose-400 text-xl"})],-1),Me={class:"p-6"};function Ne(t,s,o,_,n,a){const i=g("toastMessage"),d=g("UploadAdminManage"),p=g("CompositionItem");return u(),b("main",Ue,[l(i),e("section",Ce,[e("div",Fe,[e("div",ze,[l(d,{ref:"upload",addSong:a.addSong},null,8,["addSong"])]),e("div",Ie,[e("div",Te,[De,e("div",Me,[(u(!0),b(w,null,D(n.songs,(c,r)=>(u(),$(p,{key:c.docID,song:c,updateSong:a.updateSong,index:r,removeSong:a.removeSong,updateUnsaveFlag:a.updateUnsaveFlag},null,8,["song","updateSong","index","removeSong","updateUnsaveFlag"]))),128))])])])])])])}const Ee=k(ke,[["render",Ne]]);export{Ee as default};
